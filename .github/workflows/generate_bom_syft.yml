name: Syft SBOM Runner

on:
  workflow_dispatch:
  pull_request:
    types:
      - opened

concurrency:
  group: dtrack-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  generatebom:
    runs-on: bom
    permissions:
      contents: read
      actions: read
      security-events: write
    steps:
      - uses: actions/checkout@v4

      - name: Read node version (fallback 20)
        run: |
          if [ -f .nvmrc ]; then
            echo "NODE_VERSION=$(tr -d 'v' < .nvmrc)" >> "$GITHUB_ENV"
          else
            echo "NODE_VERSION=20" >> "$GITHUB_ENV"
          fi

      - name: Yarn install + SBOM (container)
        run: |
          podman run --rm \
            -v "$GITHUB_WORKSPACE:/work" -w /work \
            node:${NODE_VERSION}-bullseye \
            bash -lc '
              set -e
              corepack enable
              yarn install

              # Install syft in the container
              curl -sSfL https://raw.githubusercontent.com/anchore/syft/main/install.sh \
                | sh -s -- -b /usr/local/bin

              # Generate CycloneDX JSON SBOM
              syft . -o cyclonedx-json=bom_syft.json
            '

      - name: Upload BOM to Dependency-Track and fetch metrics
        id: dtrack_syft
        env:
          DTRACK_URL: ${{ vars.DTRACK_URL }}
          DTRACK_API_KEY: ${{ secrets.DTRACK_API_KEY }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          set -euo pipefail

          test -f bom_syft.json || { echo "bom_syft.json not found"; ls -lah; exit 1; }

          projectName="${GITHUB_REPOSITORY}-syft"
          
          if [ -n "${PR_NUMBER:-}" ]; then
            projectVersion="pr-${PR_NUMBER}"
          else
            projectVersion="${GITHUB_REF_NAME:-main}"
          fi

          token="$(
            curl -sSf -X POST "$DTRACK_URL/api/v1/bom" \
              -H "X-Api-Key: $DTRACK_API_KEY" \
              -F "projectName=$projectName" \
              -F "projectVersion=$projectVersion" \
              -F "autoCreate=true" \
              -F "bom=@bom_syft.json" \
            | jq -r '.token'
          )"
          echo "Dependency-Track token: $token"

          echo "Waiting for Dependency-Track to finish processing..."
          processing="true"
          for i in {1..120}; do
              processing="$(curl -sSf "$DTRACK_URL/api/v1/bom/token/$token" -H "X-Api-Key: $DTRACK_API_KEY" | jq -r '.processing')"
              if [ "$processing" = "false" ]; then
              echo "Processing finished."
              break
            fi
            sleep 5
          done

          if [ "$processing" != "false" ]; then
            echo "Timed out waiting for BOM processing"
            exit 1
          fi
          
          projectNameEnc=$(printf '%s' "$projectName" | jq -sRr @uri)
          projectVersionEnc=$(printf '%s' "$projectVersion" | jq -sRr @uri)

          project="$(curl -sSf \
          "$DTRACK_URL/api/v1/project/lookup?name=${projectNameEnc}&version=${projectVersionEnc}" \
          -H "X-Api-Key: $DTRACK_API_KEY")"

          uuid="$(echo "$project" | jq -r '.uuid // empty')"
          if [ -z "$uuid" ]; then
            echo "::error::Could not resolve project UUID from Dependency-Track lookup"
            echo "$project"
            exit 1
          fi
          echo "Project UUID: $uuid"

          metrics="$(curl -sSf "$DTRACK_URL/api/v1/metrics/project/$uuid/current" -H "X-Api-Key: $DTRACK_API_KEY")"

          echo "=== Metrics ==="
          echo "$metrics" | jq '{critical, high, medium, low, unassigned, vulnerabilities, vulnerableComponents, components}'

          crit="$(echo "$metrics" | jq -r '.critical // 0')"
          high="$(echo "$metrics" | jq -r '.high // 0')"
          
          crit="$(echo "$crit" | tr -d '\r\n ')"
          high="$(echo "$high" | tr -d '\r\n ')"
          
          echo "Collected gate values: critical=[$crit] high=[$high]"

          if ! [[ "$crit" =~ ^[0-9]+$ ]] || ! [[ "$high" =~ ^[0-9]+$ ]]; then
            echo "::error::Invalid metrics values: critical=[$crit], high=[$high]"
            exit 1
          fi

          echo "project_uuid=$uuid" >> "$GITHUB_OUTPUT"
          echo "critical=$crit" >> "$GITHUB_OUTPUT"
          echo "high=$high" >> "$GITHUB_OUTPUT"

      - name: Trigger Dependency-Track analysis and wait
        env:
          DTRACK_URL: ${{ vars.DTRACK_URL }}
          DTRACK_API_KEY: ${{ secrets.DTRACK_API_KEY }}
          PROJECT_UUID: ${{ steps.dtrack_syft.outputs.project_uuid }}
        run: |
          set -euo pipefail

          analysis_token="$(
            curl -sSf -X POST "$DTRACK_URL/api/v1/finding/project/$PROJECT_UUID/analyze" \
              -H "X-Api-Key: $DTRACK_API_KEY" \
            | jq -r '.token // empty'
          )"

          if [ -z "$analysis_token" ]; then
            echo "::error::Dependency-Track analysis token was empty"
            exit 1
          fi

          echo "Waiting for Dependency-Track analysis to finish..."
          processing="true"
          for i in {1..120}; do
            processing="$(curl -sSf "$DTRACK_URL/api/v1/event/token/$analysis_token" -H "X-Api-Key: $DTRACK_API_KEY" | jq -r '.processing')"
            if [ "$processing" = "false" ]; then
              echo "Analysis finished."
              break
            fi
            sleep 5
          done

          if [ "$processing" != "false" ]; then
            echo "::error::Timed out waiting for Dependency-Track analysis"
            exit 1
          fi

      - name: Export SARIF findings (syft)
        env:
          DTRACK_URL: ${{ vars.DTRACK_URL }}
          DTRACK_API_KEY: ${{ secrets.DTRACK_API_KEY }}
          PROJECT_UUID: ${{ steps.dtrack_syft.outputs.project_uuid }}
        run: |
          set -euo pipefail

          curl -sSf "$DTRACK_URL/api/v1/finding/project/$PROJECT_UUID?suppressed=false" \
            -H "X-Api-Key: $DTRACK_API_KEY" \
            -H "Accept: application/sarif+json" \
            -o dtrack-syft.sarif

          test -s dtrack-syft.sarif || { echo "::error::dtrack-syft.sarif is missing or empty"; exit 1; }
          jq -e '.runs and (.runs | type == "array")' dtrack-syft.sarif >/dev/null

      - name: Export VEX and VDR JSON for SARIF mapping (syft)
        env:
          DTRACK_URL: ${{ vars.DTRACK_URL }}
          DTRACK_API_KEY: ${{ secrets.DTRACK_API_KEY }}
          PROJECT_UUID: ${{ steps.dtrack_syft.outputs.project_uuid }}
        run: |
          set -euo pipefail

          curl -sSf "$DTRACK_URL/api/v1/vex/cyclonedx/project/$PROJECT_UUID" \
            -H "X-Api-Key: $DTRACK_API_KEY" \
            -o vex_syft.json

          curl -sSf "$DTRACK_URL/api/v1/bom/cyclonedx/project/$PROJECT_UUID?variant=vdr&format=JSON" \
            -H "X-Api-Key: $DTRACK_API_KEY" \
            -o vdr_syft.json

          test -s vex_syft.json || { echo "::error::vex_syft.json is missing or empty"; exit 1; }
          test -s vdr_syft.json || { echo "::error::vdr_syft.json is missing or empty"; exit 1; }

      - name: Normalize SARIF for GitHub Code Scanning (syft)
        run: |
          set -euo pipefail

          python3 scripts/normalize_sarif.py \
            --input-sarif dtrack-syft.sarif \
            --output-sarif dtrack-syft.sarif \
            --vdr vdr_syft.json \
            --vex vex_syft.json \
            --source syft-test \
            --tool-name "OWASP Dependency-Track (syft-test)" \
            --rule-id-namespace "syft-test::" \
            --location-mode fallback \
            --fallback-uri bom.json \
            --fallback-line 1

          jq -e '.runs[0].results[0].locations[0].physicalLocation.artifactLocation.uri' dtrack-syft.sarif >/dev/null

      - name: Debug normalized SARIF identity (syft)
        run: |
          set -euo pipefail
          echo "Tool name:"
          jq -r '.runs[0].tool.driver.name' dtrack-syft.sarif
          echo "First 5 rule IDs:"
          jq -r '.runs[0].results[0:5][] | .ruleId' dtrack-syft.sarif

      - name: Snapshot open code scanning alerts before SARIF upload (syft)
        id: code_scanning_before_syft
        env:
          GH_TOKEN: ${{ github.token }}
          BASE_REF: ${{ github.base_ref }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          DEFAULT_BRANCH: ${{ github.event.repository.default_branch }}
          TOOL_NAME: OWASP Dependency-Track (syft-test)
        run: |
          set -euo pipefail

          urlencode() {
            jq -rn --arg value "$1" '$value|@uri'
          }

          fetch_alert_numbers() {
            local ref="$1"
            local severity="$2"
            local encoded_ref encoded_tool page response count
            encoded_ref="$(urlencode "$ref")"
            encoded_tool="$(urlencode "$TOOL_NAME")"
            page=1
            while :; do
              response="$(curl -fsSL \
                -H "Authorization: Bearer $GH_TOKEN" \
                -H "Accept: application/vnd.github+json" \
                "$GITHUB_API_URL/repos/$GITHUB_REPOSITORY/code-scanning/alerts?state=open&tool_name=$encoded_tool&severity=$severity&ref=$encoded_ref&per_page=100&page=$page")"
              count="$(echo "$response" | jq 'length')"
              if [ "$count" -eq 0 ]; then
                break
              fi
              echo "$response" | jq -r '.[].number'
              page=$((page + 1))
            done | sed '/^$/d' | sort -n -u
          }

          if [ "$GITHUB_EVENT_NAME" = "pull_request" ] && [ -n "${PR_NUMBER:-}" ]; then
            head_ref="refs/pull/${PR_NUMBER}/merge"
            base_ref="refs/heads/${BASE_REF}"
            branch_name="${GITHUB_HEAD_REF}"
          else
            head_ref="refs/heads/${GITHUB_REF_NAME}"
            base_ref="refs/heads/${DEFAULT_BRANCH:-main}"
            branch_name="${GITHUB_REF_NAME}"
          fi

          before_critical="$(fetch_alert_numbers "$head_ref" "critical" || true)"
          before_high="$(fetch_alert_numbers "$head_ref" "high" || true)"

          before_critical_file="$RUNNER_TEMP/dtrack_syft_before_critical.txt"
          before_high_file="$RUNNER_TEMP/dtrack_syft_before_high.txt"
          printf '%s\n' "$before_critical" | sed '/^$/d' | sort -n -u > "$before_critical_file"
          printf '%s\n' "$before_high" | sed '/^$/d' | sort -n -u > "$before_high_file"

          before_critical_count="$(wc -l < "$before_critical_file" | tr -d ' ')"
          before_high_count="$(wc -l < "$before_high_file" | tr -d ' ')"
          before_total_count=$((before_critical_count + before_high_count))

          echo "Head ref: $head_ref"
          echo "Base ref: $base_ref"
          echo "Before upload open critical alerts: $before_critical_count"
          echo "Before upload open high alerts: $before_high_count"
          echo "Before upload open total alerts: $before_total_count"

          {
            echo "head_ref=$head_ref"
            echo "base_ref=$base_ref"
            echo "branch_name=$branch_name"
            echo "before_critical_count=$before_critical_count"
            echo "before_high_count=$before_high_count"
            echo "before_total_count=$before_total_count"
          } >> "$GITHUB_OUTPUT"

      - name: Upload SARIF to GitHub Code Scanning (syft)
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: dtrack-syft.sarif
          category: dependency-track-syft-test

      # Computes two metrics:
      # 1) introduced_vs_base: open(head) - open(base) for gating PR risk.
      # 2) new_this_run: open(after upload) - open(before upload) for run-level visibility.
      - name: Compute code scanning deltas after SARIF upload (syft, high/critical)
        id: code_scanning_syft
        env:
          GH_TOKEN: ${{ github.token }}
          TOOL_NAME: OWASP Dependency-Track (syft-test)
          HEAD_REF: ${{ steps.code_scanning_before_syft.outputs.head_ref }}
          BASE_REF: ${{ steps.code_scanning_before_syft.outputs.base_ref }}
          BRANCH_NAME: ${{ steps.code_scanning_before_syft.outputs.branch_name }}
        run: |
          set -euo pipefail

          urlencode() {
            jq -rn --arg value "$1" '$value|@uri'
          }

          fetch_alert_numbers() {
            local ref="$1"
            local severity="$2"
            local encoded_ref encoded_tool page response count
            encoded_ref="$(urlencode "$ref")"
            encoded_tool="$(urlencode "$TOOL_NAME")"
            page=1
            while :; do
              response="$(curl -fsSL \
                -H "Authorization: Bearer $GH_TOKEN" \
                -H "Accept: application/vnd.github+json" \
                "$GITHUB_API_URL/repos/$GITHUB_REPOSITORY/code-scanning/alerts?state=open&tool_name=$encoded_tool&severity=$severity&ref=$encoded_ref&per_page=100&page=$page")"
              count="$(echo "$response" | jq 'length')"
              if [ "$count" -eq 0 ]; then
                break
              fi
              echo "$response" | jq -r '.[].number'
              page=$((page + 1))
            done | sed '/^$/d' | sort -n -u
          }

          count_diff() {
            local left="$1"
            local right="$2"
            local left_file right_file
            left_file="$(mktemp)"
            right_file="$(mktemp)"
            printf '%s\n' "$left" | sed '/^$/d' | sort -n -u > "$left_file"
            printf '%s\n' "$right" | sed '/^$/d' | sort -n -u > "$right_file"
            comm -23 "$left_file" "$right_file" | sed '/^$/d' | wc -l | tr -d ' '
            rm -f "$left_file" "$right_file"
          }

          after_critical="$(fetch_alert_numbers "$HEAD_REF" "critical" || true)"
          after_high="$(fetch_alert_numbers "$HEAD_REF" "high" || true)"
          base_critical="$(fetch_alert_numbers "$BASE_REF" "critical" || true)"
          base_high="$(fetch_alert_numbers "$BASE_REF" "high" || true)"

          before_critical="$(cat "$RUNNER_TEMP/dtrack_syft_before_critical.txt" 2>/dev/null || true)"
          before_high="$(cat "$RUNNER_TEMP/dtrack_syft_before_high.txt" 2>/dev/null || true)"

          introduced_critical="$(count_diff "$after_critical" "$base_critical")"
          introduced_high="$(count_diff "$after_high" "$base_high")"
          introduced_total=$((introduced_critical + introduced_high))

          new_this_run_critical="$(count_diff "$after_critical" "$before_critical")"
          new_this_run_high="$(count_diff "$after_high" "$before_high")"
          new_this_run_total=$((new_this_run_critical + new_this_run_high))

          query="is:open branch:${BRANCH_NAME} tool:\"${TOOL_NAME}\""
          branch_url="https://github.com/${GITHUB_REPOSITORY}/security/code-scanning?query=$(urlencode "$query")"

          echo "Head ref: $HEAD_REF"
          echo "Base ref: $BASE_REF"
          echo "Introduced vs base (critical/high/total): $introduced_critical/$introduced_high/$introduced_total"
          echo "New in this run (critical/high/total): $new_this_run_critical/$new_this_run_high/$new_this_run_total"
          echo "Branch code scanning URL: $branch_url"

          {
            echo "introduced_critical=$introduced_critical"
            echo "introduced_high=$introduced_high"
            echo "introduced_total=$introduced_total"
            echo "new_this_run_critical=$new_this_run_critical"
            echo "new_this_run_high=$new_this_run_high"
            echo "new_this_run_total=$new_this_run_total"
            echo "branch_url=$branch_url"
            echo "head_ref=$HEAD_REF"
            echo "base_ref=$BASE_REF"
          } >> "$GITHUB_OUTPUT"

      - name: Report code scanning summary (syft)
        run: |
          set -euo pipefail

          introduced_critical="${{ steps.code_scanning_syft.outputs.introduced_critical }}"
          introduced_high="${{ steps.code_scanning_syft.outputs.introduced_high }}"
          introduced_total="${{ steps.code_scanning_syft.outputs.introduced_total }}"
          new_this_run_critical="${{ steps.code_scanning_syft.outputs.new_this_run_critical }}"
          new_this_run_high="${{ steps.code_scanning_syft.outputs.new_this_run_high }}"
          new_this_run_total="${{ steps.code_scanning_syft.outputs.new_this_run_total }}"
          branch_url="${{ steps.code_scanning_syft.outputs.branch_url }}"
          introduced_critical="${introduced_critical:-0}"
          introduced_high="${introduced_high:-0}"
          introduced_total="${introduced_total:-0}"
          new_this_run_critical="${new_this_run_critical:-0}"
          new_this_run_high="${new_this_run_high:-0}"
          new_this_run_total="${new_this_run_total:-0}"

          echo "::notice::Syft alerts: introduced_vs_base critical=$introduced_critical high=$introduced_high | new_this_run critical=$new_this_run_critical high=$new_this_run_high"
          echo "### Syft code scanning" >> "$GITHUB_STEP_SUMMARY"
          echo "- Introduced vs base critical alerts: $introduced_critical" >> "$GITHUB_STEP_SUMMARY"
          echo "- Introduced vs base high alerts: $introduced_high" >> "$GITHUB_STEP_SUMMARY"
          echo "- Introduced vs base total alerts: $introduced_total" >> "$GITHUB_STEP_SUMMARY"
          echo "- New in this run critical alerts: $new_this_run_critical" >> "$GITHUB_STEP_SUMMARY"
          echo "- New in this run high alerts: $new_this_run_high" >> "$GITHUB_STEP_SUMMARY"
          echo "- New in this run total alerts: $new_this_run_total" >> "$GITHUB_STEP_SUMMARY"
          echo "- Branch alerts URL: $branch_url" >> "$GITHUB_STEP_SUMMARY"

      - name: Enforce introduced vulnerability gate (critical/high)
        run: |
          set -euo pipefail

          crit="${{ steps.code_scanning_syft.outputs.introduced_critical }}"
          high="${{ steps.code_scanning_syft.outputs.introduced_high }}"
          crit="${crit:-0}"
          high="${high:-0}"
          branch_url="${{ steps.code_scanning_syft.outputs.branch_url }}"

          echo "Final gate values (introduced vs base): critical=[$crit] high=[$high]"

          if [ "$crit" -gt 0 ] || [ "$high" -gt 0 ]; then
            echo "::error::Found introduced-vs-base critical/high code scanning alerts (critical=$crit, high=$high). Review: $branch_url"
            exit 1
          fi

          echo "No introduced critical or high alerts"
