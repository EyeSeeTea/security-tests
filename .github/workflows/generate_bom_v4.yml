name: Generate Bom Yarn 4 CycloneDX

on:
  workflow_dispatch:
  pull_request:
  push:
    branches:
      - '**'

jobs:
  generatebomv4:
    runs-on: bom
    permissions:
      contents: read
      actions: read
      security-events: write
    steps:
      - uses: actions/checkout@v4

      - name: Read node version (min 20.18.0 for CycloneDX)
        run: |
          if [ -f .nvmrc ]; then
            ver="$(tr -d 'v' < .nvmrc)"
          else
            ver="20.18.0"
          fi
          min="20.18.0"
          if [ "$(printf '%s\n' "$ver" "$min" | sort -V | head -n1)" = "$ver" ] && [ "$ver" != "$min" ]; then
            ver="$min"
          fi
          echo "NODE_VERSION=$ver" >> "$GITHUB_ENV"

      - name: Yarn Berry + CycloneDX (container)
        run: |
          podman run --rm \
            -v "$GITHUB_WORKSPACE:/work" -w /work \
            node:${NODE_VERSION}-bullseye \
            bash -lc '
              corepack enable
              yarn set version berry
              if [ ! -f src/package.json ]; then
                printf "{\n  \"name\": \"local-src\",\n  \"version\": \"0.0.0\"\n}\n" > src/package.json
              fi
              # CycloneDX rejects invalid package names like "$"; strip for BOM generation only.
              cp package.json /tmp/package.json.orig
              node -e "const fs=require(\"fs\");const pkg=JSON.parse(fs.readFileSync(\"package.json\",\"utf8\"));if(pkg.dependencies&&pkg.dependencies[\"\\$\"]){delete pkg.dependencies[\"\\$\"];};fs.writeFileSync(\"package.json\",JSON.stringify(pkg,null,2)+\"\\n\");"
              yarn install
              yarn dlx -q @cyclonedx/yarn-plugin-cyclonedx --output-file bom_berry.json --output-format JSON
              mv /tmp/package.json.orig package.json '

      - name: Upload BOM to Dependency-Track and fetch metrics
        id: dtrack_yarn4
        env:
          DTRACK_URL: ${{ vars.DTRACK_URL }}
          DTRACK_API_KEY: ${{ secrets.DTRACK_API_KEY }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          set -euo pipefail

          test -f bom_berry.json || { echo "bom_berry.json not found"; ls -lah; exit 1; }

          projectName="${GITHUB_REPOSITORY}-berry"
          if [ -n "${PR_NUMBER:-}" ]; then
            projectVersion="pr-${PR_NUMBER}"
          else
            projectVersion="${GITHUB_REF_NAME:-main}"
          fi

          token="$(
            curl -sSf -X POST "$DTRACK_URL/api/v1/bom" \
              -H "X-Api-Key: $DTRACK_API_KEY" \
              -F "projectName=$projectName" \
              -F "projectVersion=$projectVersion" \
              -F "autoCreate=true" \
              -F "bom=@bom_berry.json" \
            | jq -r '.token'
          )"
          echo "Dependency-Track token: $token"

          echo "Waiting for Dependency-Track to finish processing..."
          processing="true"
          for i in {1..120}; do
              processing="$(curl -sSf "$DTRACK_URL/api/v1/bom/token/$token" -H "X-Api-Key: $DTRACK_API_KEY" | jq -r '.processing')"
              if [ "$processing" = "false" ]; then
              echo "Processing finished."
              break
            fi
            sleep 5
          done

          if [ "$processing" != "false" ]; then
            echo "Timed out waiting for BOM processing"
            exit 1
          fi
          
          projectNameEnc=$(printf '%s' "$projectName" | jq -sRr @uri)
          projectVersionEnc=$(printf '%s' "$projectVersion" | jq -sRr @uri)

          project="$(curl -sSf \
          "$DTRACK_URL/api/v1/project/lookup?name=${projectNameEnc}&version=${projectVersionEnc}" \
          -H "X-Api-Key: $DTRACK_API_KEY")"

          uuid="$(echo "$project" | jq -r '.uuid // empty')"
          if [ -z "$uuid" ]; then
            echo "::error::Could not resolve project UUID from Dependency-Track lookup"
            echo "$project"
            exit 1
          fi
          echo "Project UUID: $uuid"

          metrics="$(curl -sSf "$DTRACK_URL/api/v1/metrics/project/$uuid/current" -H "X-Api-Key: $DTRACK_API_KEY")"

          echo "=== Metrics ==="
          echo "$metrics" | jq '{critical, high, medium, low, unassigned, vulnerabilities, vulnerableComponents, components}'

          crit="$(echo "$metrics" | jq -r '.critical // 0')"
          high="$(echo "$metrics" | jq -r '.high // 0')"
          
          crit="$(echo "$crit" | tr -d '\r\n ')"
          high="$(echo "$high" | tr -d '\r\n ')"
          
          echo "Collected gate values: critical=[$crit] high=[$high]"

          if ! [[ "$crit" =~ ^[0-9]+$ ]] || ! [[ "$high" =~ ^[0-9]+$ ]]; then
            echo "::error::Invalid metrics values: critical=[$crit], high=[$high]"
            exit 1
          fi

          echo "project_uuid=$uuid" >> "$GITHUB_OUTPUT"
          echo "critical=$crit" >> "$GITHUB_OUTPUT"
          echo "high=$high" >> "$GITHUB_OUTPUT"

      - name: Trigger Dependency-Track analysis and wait
        env:
          DTRACK_URL: ${{ vars.DTRACK_URL }}
          DTRACK_API_KEY: ${{ secrets.DTRACK_API_KEY }}
          PROJECT_UUID: ${{ steps.dtrack_yarn4.outputs.project_uuid }}
        run: |
          set -euo pipefail

          analysis_token="$(
            curl -sSf -X POST "$DTRACK_URL/api/v1/finding/project/$PROJECT_UUID/analyze" \
              -H "X-Api-Key: $DTRACK_API_KEY" \
            | jq -r '.token // empty'
          )"

          if [ -z "$analysis_token" ]; then
            echo "::error::Dependency-Track analysis token was empty"
            exit 1
          fi

          echo "Waiting for Dependency-Track analysis to finish..."
          processing="true"
          for i in {1..120}; do
            processing="$(curl -sSf "$DTRACK_URL/api/v1/event/token/$analysis_token" -H "X-Api-Key: $DTRACK_API_KEY" | jq -r '.processing')"
            if [ "$processing" = "false" ]; then
              echo "Analysis finished."
              break
            fi
            sleep 5
          done

          if [ "$processing" != "false" ]; then
            echo "::error::Timed out waiting for Dependency-Track analysis"
            exit 1
          fi

      - name: Export SARIF findings (yarn4)
        env:
          DTRACK_URL: ${{ vars.DTRACK_URL }}
          DTRACK_API_KEY: ${{ secrets.DTRACK_API_KEY }}
          PROJECT_UUID: ${{ steps.dtrack_yarn4.outputs.project_uuid }}
        run: |
          set -euo pipefail

          curl -sSf "$DTRACK_URL/api/v1/finding/project/$PROJECT_UUID?suppressed=false" \
            -H "X-Api-Key: $DTRACK_API_KEY" \
            -H "Accept: application/sarif+json" \
            -o dtrack-yarn4.sarif

          test -s dtrack-yarn4.sarif || { echo "::error::dtrack-yarn4.sarif is missing or empty"; exit 1; }
          jq -e '.runs and (.runs | type == "array")' dtrack-yarn4.sarif >/dev/null

      - name: Export VEX and VDR JSON for SARIF mapping (yarn4)
        env:
          DTRACK_URL: ${{ vars.DTRACK_URL }}
          DTRACK_API_KEY: ${{ secrets.DTRACK_API_KEY }}
          PROJECT_UUID: ${{ steps.dtrack_yarn4.outputs.project_uuid }}
        run: |
          set -euo pipefail

          curl -sSf "$DTRACK_URL/api/v1/vex/cyclonedx/project/$PROJECT_UUID" \
            -H "X-Api-Key: $DTRACK_API_KEY" \
            -o vex_yarn4.json

          curl -sSf "$DTRACK_URL/api/v1/bom/cyclonedx/project/$PROJECT_UUID?variant=vdr&format=JSON" \
            -H "X-Api-Key: $DTRACK_API_KEY" \
            -o bom_yarn4.json

          test -s vex_yarn4.json || { echo "::error::vex_yarn4.json is missing or empty"; exit 1; }
          test -s bom_yarn4.json || { echo "::error::bom_yarn4.json is missing or empty"; exit 1; }

      - name: Normalize SARIF for GitHub Code Scanning (yarn4)
        run: |
          set -euo pipefail

          jq --slurpfile vdr bom_yarn4.json --slurpfile vex vex_yarn4.json '
            def to_num:
              if . == null then null
              elif type == "number" then .
              elif type == "string" then
                (if test("^[0-9]+(\\.[0-9]+)?$") then tonumber else null end)
              else null end;

            def score_from_result:
              (
                (.properties.cvssV3BaseScore // null | to_num)
                //
                ((.properties.severityRank // null | to_num) as $rank |
                  if $rank == 0 then 9.0
                  elif $rank == 1 then 8.0
                  elif $rank == 2 then 5.0
                  elif $rank == 3 then 2.0
                  else null
                  end)
              );

            def normalize_path:
              tostring | gsub("\\\\"; "/") | sub("^/+"; "");

            def component_paths($component):
              (
                [ ($component.properties // [])[]?
                  | select(type == "object")
                  | select((.name // "") | type == "string")
                  | select((.name | startswith("syft:location:")) and (.name | endswith(":path")))
                  | (.value // empty)
                  | tostring
                  | normalize_path
                  | select(length > 0)
                ]
                +
                [ ($component.evidence.occurrences // [])[]?
                  | .location?
                  | select(type == "string")
                  | normalize_path
                  | select(length > 0)
                ]
              );

            def purl_to_path_map($bom):
              reduce (($bom.components // [])[]? | select(type == "object")) as $component
                ({};
                  (component_paths($component) | .[0]) as $path
                  | if $path == null then .
                    else
                      .
                      + (if (($component.purl // "") | tostring | length) > 0 then { (($component.purl | tostring)): $path } else {} end)
                      + (if (($component["bom-ref"] // "") | tostring | length) > 0 then { (($component["bom-ref"] | tostring)): $path } else {} end)
                    end
                );

            def has_text($value):
              $value != null and (($value | tostring) | length) > 0;

            def first_doc($docs):
              ($docs[0] // {});

            def vulnerability_url_map($doc):
              reduce (($doc.vulnerabilities // [])[]? | select(type == "object")) as $v
                ({};
                  ($v.id // "") as $id
                  | if has_text($id) then
                      ($v.source.url // null) as $source_url
                      | (
                          ($v.references // [])
                          | map(.url? // empty | tostring)
                          | map(select(length > 0))
                          | .[0] // null
                        ) as $ref_url
                      | ($source_url // $ref_url) as $url
                      | if has_text($url) then
                          . + { (($id | tostring)): ($url | tostring) }
                        else
                          .
                        end
                    else
                      .
                    end
                );

            def advisory_url($rule_id; $url_map; $existing):
              if has_text($existing) then
                ($existing | tostring)
              elif has_text($url_map[$rule_id]) then
                ($url_map[$rule_id] | tostring)
              else
                null
              end;

            def clean_summary($text):
              (($text // "")
                | tostring
                | split("\n")
                | map(gsub("\r"; ""))
                | map(sub("^#+\\s*"; ""))
                | map(select(length > 0))
                | map(select(. != "Summary" and . != "Details" and . != "Impact" and . != "PoC"))
                | .[0] // ""
              );

            (vulnerability_url_map(first_doc($vdr))) as $vdr_url_map
            | (vulnerability_url_map(first_doc($vex))) as $vex_url_map
            | (
                reduce ($vex_url_map | to_entries[]) as $entry ($vdr_url_map;
                  if has_text(.[ $entry.key ]) then
                    .
                  else
                    . + { ($entry.key): $entry.value }
                  end
                )
              ) as $url_by_rule
            | (purl_to_path_map(first_doc($vdr))) as $purl_path
            |
            .runs |= map(
              .tool.driver.name = "OWASP Dependency-Track (yarn4-test)"
              | .tool.driver.rules |= map(
                  (.id // "Dependency-Track finding") as $rule_id
                  | (advisory_url($rule_id; $url_by_rule; (.helpUri // null))) as $help_url
                  | .shortDescription.text = ("[yarn4] " + ((.shortDescription.text // .id // "Dependency-Track finding") | tostring))
                  | .fullDescription.text = ("[yarn4] " + ($rule_id | tostring))
                  | if has_text($help_url) then
                      .helpUri = $help_url
                    else
                      .
                    end
                )
              | .results |= map(
                  . as $result
                  | (.ruleId // "Dependency-Track finding") as $rule_id
                  | (advisory_url($rule_id; $url_by_rule; null)) as $help_url
                  | (.properties.name // "unknown-package") as $package_name
                  | (.properties.version // "") as $package_version
                  | (.message.text // "") as $raw_detail
                  | (clean_summary($raw_detail)) as $summary_line_raw
                  | (if (($summary_line_raw | tostring | length) > 180) then (($summary_line_raw | tostring)[0:180] + "...") else ($summary_line_raw | tostring) end) as $summary_line
                  | (score_from_result) as $score
                  | (.locations[0].logicalLocations[0].fullyQualifiedName // "") as $logical_key
                  | ($purl_path[$logical_key] // null) as $mapped_path
                  | .properties = (
                      (.properties // {})
                      + { scan_source: "yarn4" }
                      + (if has_text($help_url) then { advisory_url: $help_url } else {} end)
                      + (if has_text($raw_detail) then { advisory_detail: $raw_detail } else {} end)
                    )
                  | .message.text = (
                      "[yarn4] "
                      + ($rule_id | tostring)
                      + " in "
                      + ($package_name | tostring)
                      + (if has_text($package_version) then ("@" + ($package_version | tostring)) else "" end)
                      + (if has_text($summary_line) then (": " + $summary_line) else "" end)
                      + (if has_text($help_url) then (" (" + $help_url + ")") else "" end)
                    )
                  | .partialFingerprints = ((.partialFingerprints // {}) + {
                      dtrack_finding_key: (
                        [
                          "yarn4",
                          (.ruleId // ""),
                          (.properties.name // ""),
                          (.properties.group // ""),
                          (.properties.version // ""),
                          (.locations[0].logicalLocations[0].fullyQualifiedName // "")
                        ] | map(tostring) | join("|")
                      )
                    })
                  | .level = (
                      if $score == null then (.level // "warning")
                      elif $score >= 7.0 then "error"
                      elif $score >= 4.0 then "warning"
                      else "note"
                      end
                    )
                  | if ((.locations // []) | length) == 0 then
                      . + {
                        locations: [{
                          logicalLocations: [{ fullyQualifiedName: (if has_text($logical_key) then $logical_key else (.properties.name // "dependency-track") end) }],
                          physicalLocation: {
                            artifactLocation: {
                              uri: (if has_text($mapped_path) then $mapped_path else "package.json" end),
                              uriBaseId: "%SRCROOT%"
                            },
                            region: { startLine: (if has_text($mapped_path) then 1 else 2 end) }
                          }
                        }]
                      }
                    else
                      .locations |= map(
                        if .physicalLocation then
                          .physicalLocation.artifactLocation = ((.physicalLocation.artifactLocation // {}) + {
                            uri: (if has_text($mapped_path) then $mapped_path else "package.json" end),
                            uriBaseId: "%SRCROOT%"
                          })
                          | .physicalLocation.region = ((.physicalLocation.region // {}) + {
                              startLine: (if has_text($mapped_path) then (.physicalLocation.region.startLine // 1) else 2 end)
                            })
                        else
                          . + {
                            physicalLocation: {
                              artifactLocation: {
                                uri: (if has_text($mapped_path) then $mapped_path else "package.json" end),
                                uriBaseId: "%SRCROOT%"
                              },
                              region: { startLine: (if has_text($mapped_path) then 1 else 2 end) }
                            }
                          }
                        end
                      )
                    end
                )
              | (
                  reduce (.results[]?) as $r ({};
                    ($r.ruleId // "") as $rid
                    | if $rid == "" then .
                      else
                        ($r | score_from_result) as $score
                        | if $score == null then .
                          else .[$rid] = (if (.[ $rid ] // -1) > $score then .[$rid] else $score end)
                          end
                      end
                  )
                ) as $score_by_rule
              | .tool.driver.rules |= map(
                  (.id // "") as $rid
                  | if ($score_by_rule[$rid] != null) then
                      .properties = ((.properties // {}) + {
                        "security-severity": (($score_by_rule[$rid] * 10 | round / 10) | tostring),
                        "precision": (.properties.precision // "high"),
                        "tags": (((.properties.tags // []) + ["security"]) | unique)
                      })
                    else
                      .
                    end
                )
            )
          ' dtrack-yarn4.sarif > dtrack-yarn4.normalized.sarif

          mv dtrack-yarn4.normalized.sarif dtrack-yarn4.sarif
          jq -e '.runs[0].results[0].locations[0].physicalLocation.artifactLocation.uri' dtrack-yarn4.sarif >/dev/null

      - name: Upload SARIF to GitHub Code Scanning (yarn4)
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: dtrack-yarn4.sarif
          category: dependency-track-yarn4-test

      - name: Compute introduced code scanning alerts (yarn4, high/critical)
        id: code_scanning_yarn4
        env:
          GH_TOKEN: ${{ github.token }}
          BASE_REF: ${{ github.base_ref }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          DEFAULT_BRANCH: ${{ github.event.repository.default_branch }}
          TOOL_NAME: OWASP Dependency-Track (yarn4-test)
        run: |
          set -euo pipefail

          urlencode() {
            jq -rn --arg value "$1" '$value|@uri'
          }

          fetch_alert_numbers() {
            local ref="$1"
            local severity="$2"
            local encoded_ref encoded_tool page response count
            encoded_ref="$(urlencode "$ref")"
            encoded_tool="$(urlencode "$TOOL_NAME")"
            page=1
            while :; do
              response="$(curl -fsSL \
                -H "Authorization: Bearer $GH_TOKEN" \
                -H "Accept: application/vnd.github+json" \
                "$GITHUB_API_URL/repos/$GITHUB_REPOSITORY/code-scanning/alerts?state=open&tool_name=$encoded_tool&severity=$severity&ref=$encoded_ref&per_page=100&page=$page")"
              count="$(echo "$response" | jq 'length')"
              if [ "$count" -eq 0 ]; then
                break
              fi
              echo "$response" | jq -r '.[].number'
              page=$((page + 1))
            done | sed '/^$/d' | sort -n -u
          }

          count_diff() {
            local left="$1"
            local right="$2"
            local left_file right_file
            left_file="$(mktemp)"
            right_file="$(mktemp)"
            printf '%s\n' "$left" | sed '/^$/d' | sort -n -u > "$left_file"
            printf '%s\n' "$right" | sed '/^$/d' | sort -n -u > "$right_file"
            comm -23 "$left_file" "$right_file" | sed '/^$/d' | wc -l | tr -d ' '
            rm -f "$left_file" "$right_file"
          }

          if [ "$GITHUB_EVENT_NAME" = "pull_request" ] && [ -n "${PR_NUMBER:-}" ]; then
            head_ref="refs/pull/${PR_NUMBER}/merge"
            base_ref="refs/heads/${BASE_REF}"
            branch_name="${GITHUB_HEAD_REF}"
          else
            head_ref="refs/heads/${GITHUB_REF_NAME}"
            base_ref="refs/heads/${DEFAULT_BRANCH:-main}"
            branch_name="${GITHUB_REF_NAME}"
          fi

          head_critical="$(fetch_alert_numbers "$head_ref" "critical" || true)"
          head_high="$(fetch_alert_numbers "$head_ref" "high" || true)"
          base_critical="$(fetch_alert_numbers "$base_ref" "critical" || true)"
          base_high="$(fetch_alert_numbers "$base_ref" "high" || true)"

          introduced_critical="$(count_diff "$head_critical" "$base_critical")"
          introduced_high="$(count_diff "$head_high" "$base_high")"
          introduced_total=$((introduced_critical + introduced_high))

          query="is:open branch:${branch_name} tool:\"${TOOL_NAME}\""
          branch_url="https://github.com/${GITHUB_REPOSITORY}/security/code-scanning?query=$(urlencode "$query")"

          echo "Head ref: $head_ref"
          echo "Base ref: $base_ref"
          echo "Introduced critical alerts: $introduced_critical"
          echo "Introduced high alerts: $introduced_high"
          echo "Introduced total alerts: $introduced_total"
          echo "Branch code scanning URL: $branch_url"

          {
            echo "introduced_critical=$introduced_critical"
            echo "introduced_high=$introduced_high"
            echo "introduced_total=$introduced_total"
            echo "branch_url=$branch_url"
            echo "head_ref=$head_ref"
            echo "base_ref=$base_ref"
          } >> "$GITHUB_OUTPUT"

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install Python dependencies for CSV scripts
        run: |
          set -euo pipefail
          python -m pip install --upgrade pip
          pip install -r scripts/requirements.txt

      - name: Generate merged CSV (yarn4)
        run: |
          set -euo pipefail
          python scripts/merge_yarn4_vex_vdr_to_csv.py \
            --vex vex_yarn4.json \
            --vdr bom_yarn4.json \
            --output yarn4_vex_vdr.csv

      - name: Update Google Sheets tab (yarn4)
        id: sheets_yarn4
        env:
          GOOGLE_SPREADSHEET_ID: ${{ vars.GOOGLE_SPREADSHEET_ID }}
          GOOGLE_SS_SERVICE_ACCOUNT_JSON: ${{ secrets.GOOGLE_SS_SERVICE_ACCOUNT_JSON }}
        run: |
          set -euo pipefail

          if [ -z "${GOOGLE_SPREADSHEET_ID:-}" ]; then
            echo "::error::Missing vars.GOOGLE_SPREADSHEET_ID"
            exit 1
          fi

          python scripts/update_google_sheet_from_csv.py \
            --spreadsheet-id "$GOOGLE_SPREADSHEET_ID" \
            --sheet-name yarn4 \
            --csv-path yarn4_vex_vdr.csv \
            --report-severities "critical,high"

      - name: Report sheet sync (yarn4)
        run: |
          set -euo pipefail

          appended="${{ steps.sheets_yarn4.outputs.appended }}"
          appended="${appended:-0}"
          open_critical="${{ steps.sheets_yarn4.outputs.unresolved_critical }}"
          open_high="${{ steps.sheets_yarn4.outputs.unresolved_high }}"
          open_critical="${open_critical:-0}"
          open_high="${open_high:-0}"
          sheet_url="${{ steps.sheets_yarn4.outputs.sheet_url }}"

          echo "::notice::Yarn4 findings summary (False positive empty): critical=$open_critical high=$open_high"
          if [ "$open_critical" -gt 0 ] || [ "$open_high" -gt 0 ]; then
            echo "::warning::Open findings exist. Review the sheet: $sheet_url"
          fi
          echo "### Yarn4 sheet sync" >> "$GITHUB_STEP_SUMMARY"
          echo "- Appended rows: $appended" >> "$GITHUB_STEP_SUMMARY"
          echo "- Open critical (False positive empty): $open_critical" >> "$GITHUB_STEP_SUMMARY"
          echo "- Open high (False positive empty): $open_high" >> "$GITHUB_STEP_SUMMARY"
          if [ "$open_critical" -gt 0 ] || [ "$open_high" -gt 0 ]; then
            echo "- Sheet URL: $sheet_url" >> "$GITHUB_STEP_SUMMARY"
          fi
          echo "- Review tab: yarn4" >> "$GITHUB_STEP_SUMMARY"

      - name: Report code scanning summary (yarn4)
        run: |
          set -euo pipefail

          introduced_critical="${{ steps.code_scanning_yarn4.outputs.introduced_critical }}"
          introduced_high="${{ steps.code_scanning_yarn4.outputs.introduced_high }}"
          introduced_total="${{ steps.code_scanning_yarn4.outputs.introduced_total }}"
          branch_url="${{ steps.code_scanning_yarn4.outputs.branch_url }}"
          introduced_critical="${introduced_critical:-0}"
          introduced_high="${introduced_high:-0}"
          introduced_total="${introduced_total:-0}"

          echo "::notice::Yarn4 introduced alerts in current ref: critical=$introduced_critical high=$introduced_high"
          echo "### Yarn4 code scanning" >> "$GITHUB_STEP_SUMMARY"
          echo "- Introduced critical alerts: $introduced_critical" >> "$GITHUB_STEP_SUMMARY"
          echo "- Introduced high alerts: $introduced_high" >> "$GITHUB_STEP_SUMMARY"
          echo "- Introduced total alerts: $introduced_total" >> "$GITHUB_STEP_SUMMARY"
          echo "- Branch alerts URL: $branch_url" >> "$GITHUB_STEP_SUMMARY"

      - name: Enforce introduced vulnerability gate (critical/high)
        run: |
          set -euo pipefail

          crit="${{ steps.code_scanning_yarn4.outputs.introduced_critical }}"
          high="${{ steps.code_scanning_yarn4.outputs.introduced_high }}"
          crit="${crit:-0}"
          high="${high:-0}"
          branch_url="${{ steps.code_scanning_yarn4.outputs.branch_url }}"

          echo "Final introduced gate values: critical=[$crit] high=[$high]"

          if [ "$crit" -gt 0 ] || [ "$high" -gt 0 ]; then
            echo "::error::Found introduced critical/high code scanning alerts (critical=$crit, high=$high). Review: $branch_url"
            exit 1
          fi

          echo "No introduced critical or high alerts"
